# =============
# This file is automatically generated from the templates in stackabletech/operator-templating
# DON'T MANUALLY EDIT THIS FILE
# =============
---
name: Publish pull-request artifacts

on:
  pull_request:

env:
  PRODUCT_NAME: trino
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: '0'
  CARGO_PROFILE_DEV_DEBUG: '0'
  RUSTFLAGS: "-D warnings"
  REPO_HELM_URL: https://repo.stackable.tech/repository/helm-test

jobs:
  helm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v1
        with:
          version: v3.6.2

      - name: Set up Python and update cargo version.
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - run: pip install -r ./python/requirements.txt
      - run: python ./python/cargo_version.py -m pr${{ github.event.number }}

      - name: Build Docker image
        env:
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
        if: env.NEXUS_PASSWORD != null
        run: make docker

      - name: Compile chart
        run: make compile-chart

      - name: Package Chart
        run: mkdir -p target/helm && helm package --destination target/helm deploy/helm/${{ env.PRODUCT_NAME }}-operator

      - name: Publish Chart
        env:
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
        if: env.NEXUS_PASSWORD != null
        run: >-
          /usr/bin/curl
          --fail
          -u 'github:${{ secrets.NEXUS_PASSWORD }}'
          --upload-file "./$(find  target/helm/ -name '*.tgz')"
          "${{ env.REPO_HELM_URL }}/"
